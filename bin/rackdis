#!/usr/bin/env ruby

require 'rackdis'
require 'rack'
require 'slop'

opts = Slop.new help: true, strict: true, indent: 2 do
  banner "Usage: rackdis [options]"
  
  on :r, :redis=,               "The redis server location"
  on :c, :config=,              "Config file to load options from"
  on :p, :port=,                "Port to bind to"
  on :a, :address=,             "Address to bind to"
  on :d, :daemonize,            "Put rackdis in the background"
  on :log_level=,               "Log level"
  on :l, :log=,                 "Log location (- for stdout)"
  on :db=,                      "The redis db to use"
  on :allow_unsafe,             "Enable unsafe commands"
  on :force_enable=, as: Array, "Force enabling some redis commands (DANGER)"
  on :allow_batching,           "Allows batching of commands through a POST request"
end

# Show any errors with the given options
begin
  opts.parse!
  Rackdis.configure(opts.to_hash)
rescue Slop::Error, ArgumentError => e
  puts "ERROR: #{e.message}"
  puts opts
  abort
end

app = Rack::Builder.new do
  use Rack::Stream
  use Rack::Cors do
    allow do
      origins '*'
      resource '*', headers: :any, methods: :get
    end
  end
  run Rackdis::API.new
end

Rack::Handler::Thin.run(app, Rackdis.rack_options)